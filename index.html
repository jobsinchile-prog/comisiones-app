<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#f7c600">
  <meta name="description" content="Sistema de comisiones offline para vendedores">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Comisiones">
  <title>Sistema de Comisiones</title>
  <link rel="manifest" href="#" id="manifest-placeholder">
  <style>
    :root {
      --bg: #0f0f10;
      --card: #1a1a1c;
      --text: #ffffff;
      --accent: #f7c600;
      --accent-strong: #d1a400;
      --muted: #999999;
      --border: #2a2a2a;
    }
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      background: var(--bg);
      color: var(--text);
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      padding: 8px;
      overflow-x: hidden;
    }
    
    .header {
      background: var(--accent);
      padding: 16px 12px;
      border-radius: 12px;
      text-align: center;
      margin-bottom: 16px;
      box-shadow: 0 2px 8px rgba(247, 198, 0, 0.3);
    }
    
    .header h2 {
      margin: 0;
      color: #111111;
      font-size: 20px;
      font-weight: 700;
      line-height: 1.3;
    }
    
    .header p {
      margin: 4px 0 0 0;
      color: #111111;
      font-size: 13px;
      opacity: 0.85;
    }
    
    .section-title {
      font-size: 16px;
      font-weight: 700;
      color: var(--accent);
      margin: 24px 0 12px 0;
      padding-bottom: 8px;
      border-bottom: 2px solid var(--border);
    }
    
    .totals-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
      margin-bottom: 20px;
    }
    
    .total-cell {
      background: var(--card);
      border-radius: 8px;
      padding: 12px 8px;
      text-align: center;
      border: 1px solid var(--border);
      box-shadow: 0 2px 8px rgba(0,0,0,0.3);
    }
    
    .total-label {
      font-size: 11px;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 6px;
      font-weight: 600;
    }
    
    .total-value {
      font-size: 18px;
      color: var(--accent);
      font-weight: 700;
      word-break: break-word;
    }
    
    .input-group {
      display: flex;
      gap: 8px;
      margin-bottom: 20px;
    }
    
    input[type="text"] {
      flex: 1;
      background: var(--card);
      color: var(--text);
      border: 2px solid var(--border);
      border-radius: 8px;
      font-size: 16px;
      padding: 12px;
      outline: none;
      transition: border-color 0.2s;
    }
    
    input[type="text"]:focus {
      border-color: var(--accent);
    }
    
    .btn {
      padding: 12px 20px;
      border: none;
      border-radius: 10px;
      font-size: 15px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.15s;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
    }
    
    .btn:active {
      transform: scale(0.97);
    }
    
    .btn-accent {
      background: var(--accent);
      color: #111111;
    }
    
    .btn-accent:hover {
      background: var(--accent-strong);
      box-shadow: 0 4px 12px rgba(247, 198, 0, 0.4);
    }
    
    .btn-danger {
      background: #dc2626;
      color: #ffffff;
    }
    
    .btn-danger:hover {
      background: #b91c1c;
    }
    
    .btn-secondary {
      background: var(--card);
      color: var(--text);
      border: 1px solid var(--border);
    }
    
    .btn-info {
      background: #3b82f6;
      color: #ffffff;
    }
    
    .btn-info:hover {
      background: #2563eb;
    }
    
    .btn-container {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin: 16px 0;
    }
    
    .btn-container .btn {
      flex: 1;
      min-width: 140px;
    }
    
    .sales-list {
      background: var(--card);
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 20px;
      max-height: 300px;
      overflow-y: auto;
      border: 1px solid var(--border);
    }
    
    .sales-list:empty::after {
      content: "(sin ventas)";
      color: var(--muted);
      font-style: italic;
    }
    
    .sale-item {
      padding: 8px;
      border-bottom: 1px solid var(--border);
      font-size: 13px;
      line-height: 1.6;
    }
    
    .sale-item:last-child {
      border-bottom: none;
    }
    
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.8);
      z-index: 1000;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    
    .modal.active {
      display: flex;
    }
    
    .modal-content {
      background: var(--card);
      border-radius: 12px;
      padding: 24px;
      max-width: 400px;
      width: 100%;
      border: 2px solid var(--border);
    }
    
    .modal-title {
      font-size: 18px;
      font-weight: 700;
      color: var(--accent);
      margin-bottom: 16px;
    }
    
    .modal-buttons {
      display: flex;
      gap: 8px;
      margin-top: 20px;
    }
    
    .modal-buttons .btn {
      flex: 1;
    }
    
    .install-prompt {
      background: linear-gradient(135deg, var(--accent) 0%, var(--accent-strong) 100%);
      padding: 16px;
      border-radius: 12px;
      margin-bottom: 16px;
      display: none;
      align-items: center;
      gap: 12px;
    }
    
    .install-prompt.show {
      display: flex;
    }
    
    .install-prompt-text {
      flex: 1;
      color: #111111;
      font-size: 14px;
      font-weight: 600;
    }
    
    .install-prompt .btn {
      background: #111111;
      color: var(--accent);
      padding: 8px 16px;
      font-size: 13px;
    }
    
    /* ==================== NUEVOS ESTILOS PARA AN√ÅLISIS ==================== */
    .analysis-screen {
      display: none;
      animation: fadeIn 0.3s ease;
    }
    
    .analysis-screen.active {
      display: block;
    }
    
    .kpi-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
      margin-bottom: 20px;
    }
    
    .kpi-card {
      background: var(--card);
      border-radius: 8px;
      padding: 16px 12px;
      text-align: center;
      border: 1px solid var(--border);
      box-shadow: 0 2px 8px rgba(0,0,0,0.3);
    }
    
    .kpi-period {
      font-size: 12px;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 4px;
      font-weight: 600;
    }
    
    .kpi-title {
      font-size: 13px;
      color: var(--accent);
      margin-bottom: 8px;
      font-weight: 600;
    }
    
    .kpi-value {
      font-size: 18px;
      color: var(--text);
      font-weight: 700;
      word-break: break-word;
    }
    
    .hourly-chart-container {
      background: var(--card);
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 20px;
      border: 1px solid var(--border);
    }
    
    /* ==================== ESTILOS PARA UPLOAD ==================== */
    .file-upload-container {
      margin: 16px 0;
    }
    
    .file-input-wrapper {
      position: relative;
      overflow: hidden;
      display: inline-block;
      width: 100%;
    }
    
    .file-input-wrapper input[type=file] {
      position: absolute;
      left: 0;
      top: 0;
      opacity: 0;
      width: 100%;
      height: 100%;
      cursor: pointer;
    }
    
    .file-input-button {
      background: var(--accent);
      color: #111111;
      padding: 12px 20px;
      border-radius: 10px;
      font-size: 15px;
      font-weight: 700;
      cursor: pointer;
      display: block;
      text-align: center;
      transition: all 0.15s;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
    }
    
    .file-input-button:hover {
      background: var(--accent-strong);
      box-shadow: 0 4px 12px rgba(247, 198, 0, 0.4);
    }
    
    .file-name {
      margin-top: 8px;
      font-size: 13px;
      color: var(--muted);
      word-break: break-all;
    }
    
    .upload-preview {
      max-height: 200px;
      overflow-y: auto;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 12px;
      margin-top: 12px;
      font-size: 12px;
    }
    
    .upload-preview table {
      width: 100%;
      border-collapse: collapse;
    }
    
    .upload-preview th {
      text-align: left;
      padding: 6px;
      border-bottom: 1px solid var(--border);
      color: var(--accent);
      font-size: 11px;
    }
    
    .upload-preview td {
      padding: 6px;
      border-bottom: 1px solid var(--border);
      color: var(--text);
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    @media (max-width: 768px) {
      .header h2 { font-size: 18px; }
      .total-value { font-size: 14px; }
      .total-label { font-size: 9px; }
      .btn-container { flex-direction: column; }
      .btn-container .btn { min-width: 100%; }
      .kpi-grid { grid-template-columns: 1fr; }
      .kpi-value { font-size: 16px; }
    }
    
    @media (max-width: 480px) {
      body { padding: 4px; }
      .header h2 { font-size: 16px; }
      .total-value { font-size: 13px; }
      .total-label { font-size: 8px; }
      .totals-grid { gap: 6px; }
      .modal-content {
        padding: 16px;
        max-width: 95%;
      }
      .kpi-value { font-size: 14px; }
    }
  </style>
</head>
<body>
  <!-- Pantalla Principal (siempre visible al inicio) -->
  <div id="mainScreen">
    <div id="installPrompt" class="install-prompt">
      <div class="install-prompt-text">
        üì± Instala esta app en tu celular para usarla offline
      </div>
      <button class="btn" onclick="installApp()">Instalar</button>
    </div>

    <div class="header">
      <h2>Neum√°ticos y Llantas del Pac√≠fico</h2>
      <p>Sistema de Comisiones</p>
    </div>

    <div class="section-title">üìä Resumen de Ventas</div>
    <div class="totals-grid">
      <div class="total-cell">
        <div class="total-label">Total D√≠a (con IVA)</div>
        <div class="total-value" id="dayWithVat">$ 0</div>
      </div>
      <div class="total-cell">
        <div class="total-label">Total D√≠a (sin IVA)</div>
        <div class="total-value" id="dayWithoutVat">$ 0</div>
      </div>
      <div class="total-cell">
        <div class="total-label">Comisi√≥n D√≠a</div>
        <div class="total-value" id="dayCommission">$ 0</div>
      </div>
      <div class="total-cell">
        <div class="total-label">Total Mes (con IVA)</div>
        <div class="total-value" id="monthWithVat">$ 0</div>
      </div>
      <div class="total-cell">
        <div class="total-label">Total Mes (sin IVA)</div>
        <div class="total-value" id="monthWithoutVat">$ 0</div>
      </div>
      <div class="total-cell">
        <div class="total-label">Comisi√≥n Mes</div>
        <div class="total-value" id="monthCommission">$ 0</div>
      </div>
    </div>

    <div class="section-title">‚ûï Agregar Venta</div>
    <p style="color: var(--muted); font-size: 13px; margin-bottom: 12px;">
      Introduce el <strong>monto TOTAL con IVA</strong> (ejemplo: 119000):
    </p>
    <div class="input-group">
      <input type="text" id="amountInput" placeholder="119000" inputmode="numeric">
      <button class="btn btn-accent" onclick="addSale()">Agregar</button>
    </div>
    
    <button class="btn btn-danger" onclick="deleteLastSale()" style="width: 100%; margin-top: 8px;">
      üóëÔ∏è Eliminar √öltima Venta
    </button>

    <div class="section-title">üìÖ Ventas del D√≠a</div>
    <div class="sales-list" id="salesDay"></div>

    <div class="section-title">üìÜ Ventas del Mes</div>
    <div class="sales-list" id="salesMonth"></div>

    <div class="section-title">üìú Historial Permanente de Ventas</div>
    <div class="sales-list" id="permanentSales"></div>

    <div class="section-title">‚öôÔ∏è Acciones</div>
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin: 16px 0;">
      <button class="btn btn-danger" onclick="showCloseDayModal()">Cerrar D√≠a</button>
      <button class="btn btn-danger" onclick="showCloseMonthModal()">Cerrar Mes</button>
      <button class="btn btn-secondary" onclick="showExportModal()">Exportar Excel</button>
      <button class="btn btn-accent" onclick="showModifyModal()">Modificar Ventas</button>
      <button class="btn btn-info" onclick="showUploadModal()" style="grid-column: span 2;">
        üìÅ Subir Archivo CSV
      </button>
    </div>
    
    <!-- ==================== NUEVO BOT√ìN ==================== -->
    <div style="margin: 16px 0;">
      <button class="btn btn-accent" onclick="showAnalysisScreen()" style="width: 100%;">
        üìà An√°lisis de Ventas
      </button>
    </div>

    <div class="section-title">üìä Gr√°ficos</div>
    <div style="background: var(--card); border-radius: 12px; padding: 16px; margin-bottom: 20px; border: 1px solid var(--border);">
      <h3 style="font-size: 14px; color: var(--accent); margin-bottom: 12px; font-weight: 600;">Comisiones Diarias (Mes Actual)</h3>
      <canvas id="dailyChart" style="max-height: 250px;"></canvas>
    </div>
    
    <div style="background: var(--card); border-radius: 12px; padding: 16px; margin-bottom: 20px; border: 1px solid var(--border);">
      <h3 style="font-size: 14px; color: var(--accent); margin-bottom: 12px; font-weight: 600;">Comisiones Mensuales (Hist√≥rico)</h3>
      <canvas id="monthlyChart" style="max-height: 250px;"></canvas>
    </div>

    <div class="section-title">üîÑ Resetear Sistema</div>
    <p style="color: #dc2626; font-size: 13px; margin-bottom: 12px;">
      ‚ö†Ô∏è <strong>PELIGRO:</strong> Esta acci√≥n eliminar√° TODOS los datos guardados.
    </p>
    <button class="btn btn-danger" onclick="showResetModal()">Resetear Todo</button>
  </div>

  <!-- ==================== PANTALLA DE AN√ÅLISIS (oculta al inicio) ==================== -->
  <div id="analysisScreen" class="analysis-screen">
    <div class="header">
      <h2>An√°lisis de Ventas</h2>
      <p>KPI B√°sicos - Resumen Ejecutivo</p>
    </div>

    <div class="section-title">üìä KPI Diarios</div>
    <div class="kpi-grid">
      <div class="kpi-card">
        <div class="kpi-period">D√çA</div>
        <div class="kpi-title">Ventas Totales (sin IVA)</div>
        <div class="kpi-value" id="kpiDayTotal">$ 0</div>
      </div>
      <div class="kpi-card">
        <div class="kpi-period">D√çA</div>
        <div class="kpi-title">Cantidad de Ventas</div>
        <div class="kpi-value" id="kpiDayCount">0</div>
      </div>
      <div class="kpi-card">
        <div class="kpi-period">D√çA</div>
        <div class="kpi-title">Ticket Promedio</div>
        <div class="kpi-value" id="kpiDayAverage">$ 0</div>
      </div>
      <div class="kpi-card">
        <div class="kpi-period">D√çA</div>
        <div class="kpi-title">Comisi√≥n Vendedor</div>
        <div class="kpi-value" id="kpiDayCommission">$ 0</div>
      </div>
    </div>

    <div class="section-title">üìä KPI Semanales</div>
    <div class="kpi-grid">
      <div class="kpi-card">
        <div class="kpi-period">SEMANA</div>
        <div class="kpi-title">Ventas Totales (sin IVA)</div>
        <div class="kpi-value" id="kpiWeekTotal">$ 0</div>
      </div>
      <div class="kpi-card">
        <div class="kpi-period">SEMANA</div>
        <div class="kpi-title">Cantidad de Ventas</div>
        <div class="kpi-value" id="kpiWeekCount">0</div>
      </div>
      <div class="kpi-card">
        <div class="kpi-period">SEMANA</div>
        <div class="kpi-title">Ticket Promedio</div>
        <div class="kpi-value" id="kpiWeekAverage">$ 0</div>
      </div>
      <div class="kpi-card">
        <div class="kpi-period">SEMANA</div>
        <div class="kpi-title">Comisi√≥n Vendedor</div>
        <div class="kpi-value" id="kpiWeekCommission">$ 0</div>
      </div>
    </div>

    <div class="section-title">üìä KPI Mensuales</div>
    <div class="kpi-grid">
      <div class="kpi-card">
        <div class="kpi-period">MES</div>
        <div class="kpi-title">Ventas Totales (sin IVA)</div>
        <div class="kpi-value" id="kpiMonthTotal">$ 0</div>
      </div>
      <div class="kpi-card">
        <div class="kpi-period">MES</div>
        <div class="kpi-title">Cantidad de Ventas</div>
        <div class="kpi-value" id="kpiMonthCount">0</div>
      </div>
      <div class="kpi-card">
        <div class="kpi-period">MES</div>
        <div class="kpi-title">Ticket Promedio</div>
        <div class="kpi-value" id="kpiMonthAverage">$ 0</div>
      </div>
      <div class="kpi-card">
        <div class="kpi-period">MES</div>
        <div class="kpi-title">Comisi√≥n Vendedor</div>
        <div class="kpi-value" id="kpiMonthCommission">$ 0</div>
      </div>
    </div>

    <div class="section-title">üïí Ventas por Hora (Hoy)</div>
    <div class="hourly-chart-container">
      <canvas id="hourlyChart" style="max-height: 200px;"></canvas>
    </div>

    <!-- ==================== BOT√ìN VOLVER ==================== -->
    <div style="margin: 24px 0;">
      <button class="btn btn-accent" onclick="showMainScreen()" style="width: 100%;">
        ‚Üê Volver a la pantalla principal
      </button>
    </div>
  </div>

  <!-- ==================== MODAL SUBIR ARCHIVO (NUEVO) ==================== -->
  <div id="uploadModal" class="modal">
    <div class="modal-content" style="max-width: 500px;">
      <div class="modal-title">üìÅ Subir Archivo CSV</div>
      
      <div style="margin: 16px 0;">
        <p style="color: var(--muted); font-size: 13px; margin-bottom: 12px;">
          Sube un archivo CSV con el siguiente formato:<br>
          <strong>Fecha/Hora, Monto con IVA, Neto sin IVA, Comisi√≥n, Fecha, Mes</strong>
        </p>
        
        <div class="file-upload-container">
          <div class="file-input-wrapper">
            <button class="file-input-button">üìÇ Seleccionar archivo CSV</button>
            <input type="file" id="csvFile" accept=".csv,text/csv" onchange="handleFileSelect(event)">
          </div>
          <div id="fileName" class="file-name">No se ha seleccionado ning√∫n archivo</div>
        </div>
        
        <div id="filePreview" class="upload-preview" style="display: none;">
          <h4 style="color: var(--accent); margin-bottom: 8px; font-size: 14px;">Vista previa (primeras 5 filas):</h4>
          <table id="previewTable">
            <thead>
              <tr>
                <th>Fecha/Hora</th>
                <th>Monto IVA</th>
                <th>Neto</th>
                <th>Comisi√≥n</th>
                <th>Fecha</th>
                <th>Mes</th>
              </tr>
            </thead>
            <tbody id="previewBody">
            </tbody>
          </table>
        </div>
        
        <div id="uploadStats" style="margin-top: 12px; display: none;">
          <div style="color: var(--accent); font-weight: 600; margin-bottom: 4px;">Resumen:</div>
          <div style="font-size: 12px; color: var(--muted);">
            ‚Ä¢ Total de registros: <span id="totalRecords">0</span><br>
            ‚Ä¢ Registros nuevos: <span id="newRecords">0</span><br>
            ‚Ä¢ Total a importar: <span id="importRecords">0</span>
          </div>
        </div>
      </div>

      <div class="modal-buttons">
        <button class="btn btn-accent" onclick="processCSVFile()" id="processBtn" disabled>
          üì• Procesar Archivo
        </button>
        <button class="btn btn-secondary" onclick="hideModal('uploadModal')">‚úó Cancelar</button>
      </div>
    </div>
  </div>

  <!-- Modals (sin cambios) -->
  <div id="closeDayModal" class="modal">
    <div class="modal-content">
      <div class="modal-title">¬øConfirmar cierre de d√≠a?</div>
      <p style="color: var(--muted); margin-bottom: 16px;">Se vaciar√°n las ventas del d√≠a actual.</p>
      <div class="modal-buttons">
        <button class="btn btn-accent" onclick="confirmCloseDay()">‚úì Confirmar</button>
        <button class="btn btn-secondary" onclick="hideModal('closeDayModal')">‚úó Cancelar</button>
      </div>
    </div>
  </div>

  <div id="closeMonthModal" class="modal">
    <div class="modal-content">
      <div class="modal-title">¬øConfirmar cierre de mes?</div>
      <p style="color: var(--muted); margin-bottom: 16px;">Se vaciar√°n las ventas del d√≠a y del mes actual.</p>
      <div class="modal-buttons">
        <button class="btn btn-accent" onclick="confirmCloseMonth()">‚úì Confirmar</button>
        <button class="btn btn-secondary" onclick="hideModal('closeMonthModal')">‚úó Cancelar</button>
      </div>
    </div>
  </div>

  <div id="resetModal" class="modal">
    <div class="modal-content">
      <div class="modal-title">‚ö†Ô∏è ¬øCONFIRMAR RESETEO COMPLETO?</div>
      <p style="color: var(--muted); margin-bottom: 16px;">Se borrar√°n TODOS los datos.</p>
      <div class="modal-buttons">
        <button class="btn btn-danger" onclick="confirmReset()">‚úì S√ç, BORRAR TODO</button>
        <button class="btn btn-secondary" onclick="hideModal('resetModal')">‚úó Cancelar</button>
      </div>
    </div>
  </div>

  <div id="exportModal" class="modal">
    <div class="modal-content">
      <div class="modal-title">üìä Exportar a Excel</div>
      
      <div style="margin: 16px 0;">
        <label style="display: block; margin-bottom: 8px; color: var(--accent); font-weight: 600;">Tipo de reporte:</label>
        <select id="exportType" style="width: 100%; padding: 12px; background: var(--bg); color: var(--text); border: 2px solid var(--border); border-radius: 8px; font-size: 14px;">
          <option value="day">Ventas del D√≠a</option>
          <option value="month">Ventas del Mes</option>
          <option value="permanent">Historial Permanente</option>
        </select>
      </div>

      <div id="dateSelector" style="margin: 16px 0; display: none;">
        <label style="display: block; margin-bottom: 8px; color: var(--accent); font-weight: 600;">Seleccionar:</label>
        <select id="dateSelect" style="width: 100%; padding: 12px; background: var(--bg); color: var(--text); border: 2px solid var(--border); border-radius: 8px; font-size: 14px;">
        </select>
      </div>

      <div class="modal-buttons">
        <button class="btn btn-accent" onclick="confirmExport()">üì• Exportar</button>
        <button class="btn btn-secondary" onclick="hideModal('exportModal')">‚úó Cancelar</button>
      </div>
    </div>
  </div>

  <div id="modifyModal" class="modal">
    <div class="modal-content" style="max-width: 500px;">
      <div class="modal-title">‚úèÔ∏è Modificar Ventas</div>
      
      <div style="margin: 16px 0;">
        <label style="display: block; margin-bottom: 8px; color: var(--accent); font-weight: 600;">Acci√≥n:</label>
        <select id="modifyAction" onchange="updateModifyAction()" style="width: 100%; padding: 12px; background: var(--bg); color: var(--text); border: 2px solid var(--border); border-radius: 8px; font-size: 14px;">
          <option value="add">‚ûï Agregar Venta</option>
          <option value="delete">üóëÔ∏è Eliminar Venta</option>
          <option value="search">üîç Buscar en Historial</option>
        </select>
      </div>

      <div id="addSaleSection" style="margin: 16px 0;">
        <label style="display: block; margin-bottom: 8px; color: var(--accent); font-weight: 600;">Fecha de la venta:</label>
        <input type="date" id="saleDate" style="width: 100%; padding: 12px; background: var(--bg); color: var(--text); border: 2px solid var(--border); border-radius: 8px; font-size: 14px; margin-bottom: 12px;">
        
        <label style="display: block; margin-bottom: 8px; color: var(--accent); font-weight: 600;">Monto con IVA:</label>
        <input type="text" id="saleAmount" placeholder="119000" inputmode="numeric" style="width: 100%; padding: 12px; background: var(--bg); color: var(--text); border: 2px solid var(--border); border-radius: 8px; font-size: 14px;">
      </div>

      <div id="deleteSaleSection" style="margin: 16px 0; display: none;">
        <label style="display: block; margin-bottom: 8px; color: var(--accent); font-weight: 600;">Per√≠odo:</label>
        <select id="deletePeriod" onchange="updateDeleteList()" style="width: 100%; padding: 12px; background: var(--bg); color: var(--text); border: 2px solid var(--border); border-radius: 8px; font-size: 14px; margin-bottom: 12px;">
          <option value="day">Ventas del D√≠a</option>
          <option value="month">Ventas del Mes</option>
          <option value="permanent">Historial Permanente</option>
        </select>
        
        <label style="display: block; margin-bottom: 8px; color: var(--accent); font-weight: 600;">Seleccionar venta a eliminar:</label>
        <div id="salesListToDelete" style="max-height: 200px; overflow-y: auto; background: var(--bg); border: 1px solid var(--border); border-radius: 8px; padding: 8px;">
        </div>
      </div>

      <div id="searchSaleSection" style="margin: 16px 0; display: none;">
        <label style="display: block; margin-bottom: 8px; color: var(--accent); font-weight: 600;">Buscar en Historial Permanente:</label>
        <input type="text" id="searchQuery" placeholder="Buscar por mes (ej: 2024-12) o monto..." style="width: 100%; padding: 12px; background: var(--bg); color: var(--text); border: 2px solid var(--border); border-radius: 8px; font-size: 14px; margin-bottom: 12px;">
        
        <label style="display: block; margin-bottom: 8px; color: var(--accent); font-weight: 600;">Resultados:</label>
        <div id="searchResults" style="max-height: 200px; overflow-y: auto; background: var(--bg); border: 1px solid var(--border); border-radius: 8px; padding: 8px;">
          <div style="padding: 12px; color: var(--muted); text-align: center;">Ingrese un t√©rmino de b√∫squeda</div>
        </div>
      </div>

      <div class="modal-buttons">
        <button class="btn btn-accent" onclick="confirmModify()">‚úì Confirmar</button>
        <button class="btn btn-secondary" onclick="hideModal('modifyModal')">‚úó Cancelar</button>
      </div>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
  <script>
    const COMMISSION_RATE = 0.009;
    let deferredPrompt = null;
    let dailyChartInstance = null;
    let monthlyChartInstance = null;
    let hourlyChartInstance = null;
    
    // Variables para el archivo CSV
    let selectedFile = null;
    let csvData = [];

    // ==================== FUNCIONES PARA CAMBIAR PANTALLAS ====================
    function showMainScreen() {
      document.getElementById('mainScreen').style.display = 'block';
      document.getElementById('analysisScreen').classList.remove('active');
      refreshUI();
    }

    function showAnalysisScreen() {
      document.getElementById('mainScreen').style.display = 'none';
      document.getElementById('analysisScreen').classList.add('active');
      calculateAndDisplayKPIs();
    }

    // ==================== FUNCIONES PARA SUBIR ARCHIVOS CSV ====================
    function showUploadModal() {
      showModal('uploadModal');
      resetUploadForm();
    }

    function resetUploadForm() {
      document.getElementById('csvFile').value = '';
      document.getElementById('fileName').textContent = 'No se ha seleccionado ning√∫n archivo';
      document.getElementById('filePreview').style.display = 'none';
      document.getElementById('uploadStats').style.display = 'none';
      document.getElementById('processBtn').disabled = true;
      selectedFile = null;
      csvData = [];
    }

    function handleFileSelect(event) {
      const file = event.target.files[0];
      if (!file) {
        resetUploadForm();
        return;
      }

      selectedFile = file;
      document.getElementById('fileName').textContent = `üìÑ ${file.name} (${(file.size / 1024).toFixed(2)} KB)`;
      document.getElementById('processBtn').disabled = false;

      // Leer y previsualizar el archivo
      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const content = e.target.result;
          csvData = parseCSV(content);
          
          if (csvData.length === 0) {
            alert('El archivo CSV est√° vac√≠o o no tiene el formato correcto.');
            resetUploadForm();
            return;
          }

          // Mostrar vista previa
          showPreview(csvData);
          showUploadStats(csvData);
        } catch (error) {
          alert('Error al leer el archivo CSV: ' + error.message);
          resetUploadForm();
        }
      };
      reader.readAsText(file, 'UTF-8');
    }

    function parseCSV(content) {
      const lines = content.split('\n').filter(line => line.trim() !== '');
      
      if (lines.length === 0) {
        return [];
      }

      // Verificar si la primera l√≠nea es encabezado
      const firstLine = lines[0].toLowerCase();
      const hasHeader = firstLine.includes('fecha/hora') || firstLine.includes('monto') || firstLine.includes('comisi√≥n');
      
      const startIndex = hasHeader ? 1 : 0;
      const data = [];

      for (let i = startIndex; i < lines.length; i++) {
        const line = lines[i].trim();
        if (!line) continue;

        // Manejar comillas y separadores
        const cells = [];
        let inQuotes = false;
        let currentCell = '';
        
        for (let j = 0; j < line.length; j++) {
          const char = line[j];
          
          if (char === '"') {
            inQuotes = !inQuotes;
          } else if (char === ',' && !inQuotes) {
            cells.push(currentCell);
            currentCell = '';
          } else {
            currentCell += char;
          }
        }
        cells.push(currentCell);
        
        // Limpiar comillas y espacios
        const cleanCells = cells.map(cell => cell.replace(/"/g, '').trim());
        
        if (cleanCells.length >= 6) {
          // Formato esperado: Fecha/Hora, Monto con IVA, Neto sin IVA, Comisi√≥n, Fecha, Mes
          const [fechaHoraStr, montoConIVARaw, netoSinIVARaw, comisionRaw, fechaStr, mesStr] = cleanCells;
          
          // Convertir fechas
          const timestamp = parseDateString(fechaHoraStr);
          const dateIso = parseDateOnly(fechaStr);
          const monthId = mesStr;
          
          // Convertir n√∫meros
          const montoConIVA = parseNumber(montoConIVARaw);
          const netoSinIVA = parseNumber(netoSinIVARaw);
          const comision = parseNumber(comisionRaw);
          
          if (timestamp && !isNaN(montoConIVA) && !isNaN(netoSinIVA) && !isNaN(comision) && dateIso && monthId) {
            data.push({
              fecha_hora: fechaHoraStr,
              amount_with_vat: montoConIVA,
              net_without_vat: netoSinIVA,
              commission: comision,
              fecha: fechaStr,
              mes: mesStr,
              // Datos convertidos para el sistema
              timestamp: timestamp.toISOString(),
              date_iso: dateIso,
              month_id: monthId
            });
          }
        }
      }
      
      return data;
    }

    function parseDateString(dateStr) {
      // Formato esperado: "05/12/25 10:18" (DD/MM/YY HH:MM)
      const parts = dateStr.split(' ');
      if (parts.length !== 2) return new Date();
      
      const datePart = parts[0]; // "05/12/25"
      const timePart = parts[1]; // "10:18"
      
      const dateParts = datePart.split('/');
      if (dateParts.length !== 3) return new Date();
      
      const day = parseInt(dateParts[0]);
      const month = parseInt(dateParts[1]) - 1;
      const year = 2000 + parseInt(dateParts[2]);
      
      const timeParts = timePart.split(':');
      const hours = timeParts.length >= 1 ? parseInt(timeParts[0]) : 0;
      const minutes = timeParts.length >= 2 ? parseInt(timeParts[1]) : 0;
      
      return new Date(year, month, day, hours, minutes);
    }

    function parseDateOnly(dateStr) {
      // Formato esperado: "04/12/25" (DD/MM/YY)
      const parts = dateStr.split('/');
      if (parts.length !== 3) return '';
      
      const day = parts[0].padStart(2, '0');
      const month = parts[1].padStart(2, '0');
      const year = '20' + parts[2];
      
      return `${year}-${month}-${day}`;
    }

    function parseNumber(numStr) {
      // Eliminar puntos de miles y convertir decimales
      const clean = numStr.replace(/\./g, '').replace(',', '.');
      return parseFloat(clean) || 0;
    }

    function showPreview(data) {
      const previewBody = document.getElementById('previewBody');
      previewBody.innerHTML = '';
      
      const previewCount = Math.min(5, data.length);
      
      for (let i = 0; i < previewCount; i++) {
        const row = data[i];
        const tr = document.createElement('tr');
        
        tr.innerHTML = `
          <td>${row.fecha_hora || ''}</td>
          <td>${formatCLP(row.amount_with_vat)}</td>
          <td>${formatCLP(row.net_without_vat)}</td>
          <td>${formatCLP(row.commission)}</td>
          <td>${row.fecha || ''}</td>
          <td>${row.mes || ''}</td>
        `;
        
        previewBody.appendChild(tr);
      }
      
      document.getElementById('filePreview').style.display = 'block';
    }

    function showUploadStats(data) {
      const totalRecords = data.length;
      const permanentSales = getStorage('ventas_permanentes');
      
      // Buscar duplicados (misma fecha/hora y mismo monto)
      let newRecords = 0;
      data.forEach(row => {
        const isDuplicate = permanentSales.some(sale => 
          sale.timestamp === row.timestamp && 
          sale.amount_with_vat === row.amount_with_vat
        );
        if (!isDuplicate) newRecords++;
      });
      
      document.getElementById('totalRecords').textContent = totalRecords;
      document.getElementById('newRecords').textContent = newRecords;
      document.getElementById('importRecords').textContent = newRecords;
      
      document.getElementById('uploadStats').style.display = 'block';
    }

    function processCSVFile() {
      if (!selectedFile || csvData.length === 0) {
        alert('No hay archivo para procesar.');
        return;
      }

      const permanentSales = getStorage('ventas_permanentes');
      const salesMonth = getStorage('ventas_mes');
      const salesDay = getStorage('ventas_dia');
      const today = getCurrentDate();
      const currentMonth = getCurrentMonth();
      
      let addedToPermanent = 0;
      let addedToMonth = 0;
      let addedToDay = 0;
      let duplicates = 0;

      csvData.forEach(row => {
        // Verificar si ya existe (duplicado)
        const isDuplicate = permanentSales.some(sale => 
          sale.timestamp === row.timestamp && 
          sale.amount_with_vat === row.amount_with_vat
        );

        if (!isDuplicate) {
          // Crear objeto de venta
          const sale = {
            amount_with_vat: row.amount_with_vat,
            net_without_vat: row.net_without_vat,
            commission: row.commission,
            timestamp: row.timestamp,
            date_iso: row.date_iso,
            month_id: row.month_id
          };

          // Siempre agregar al historial permanente
          permanentSales.push(sale);
          addedToPermanent++;

          // Agregar a ventas del mes si es del mes actual
          if (row.month_id === currentMonth) {
            salesMonth.push(sale);
            addedToMonth++;
          }

          // Agregar a ventas del d√≠a si es del d√≠a actual
          if (row.date_iso === today) {
            salesDay.push(sale);
            addedToDay++;
          }
        } else {
          duplicates++;
        }
      });

      // Guardar cambios
      setStorage('ventas_permanentes', permanentSales);
      setStorage('ventas_mes', salesMonth);
      setStorage('ventas_dia', salesDay);

      // Mostrar resumen
      let message = `‚úÖ Archivo procesado correctamente:\n\n`;
      message += `‚Ä¢ Registros en CSV: ${csvData.length}\n`;
      message += `‚Ä¢ Nuevos registros agregados: ${addedToPermanent}\n`;
      message += `‚Ä¢ Duplicados omitidos: ${duplicates}\n`;
      
      if (addedToMonth > 0) {
        message += `‚Ä¢ Agregados al mes actual: ${addedToMonth}\n`;
      }
      
      if (addedToDay > 0) {
        message += `‚Ä¢ Agregados al d√≠a actual: ${addedToDay}\n`;
      }

      alert(message);
      hideModal('uploadModal');
      refreshUI();
      showToast(`‚úÖ ${addedToPermanent} ventas importadas correctamente`);
    }

    // ==================== C√ÅLCULO DE KPIs ====================
    function calculateAndDisplayKPIs() {
      const permanentSales = getStorage('ventas_permanentes');
      const today = getCurrentDate();
      const currentMonth = getCurrentMonth();
      
      const startOfWeek = getStartOfWeek();
      
      const daySales = permanentSales.filter(s => s.date_iso === today);
      const weekSales = permanentSales.filter(s => isDateInWeek(s.date_iso, startOfWeek));
      const monthSales = permanentSales.filter(s => s.month_id === currentMonth);
      
      const dayTotal = daySales.reduce((sum, s) => sum + s.net_without_vat, 0);
      const dayCount = daySales.length;
      const dayAverage = dayCount > 0 ? dayTotal / dayCount : 0;
      const dayCommission = daySales.reduce((sum, s) => sum + s.commission, 0);
      
      const weekTotal = weekSales.reduce((sum, s) => sum + s.net_without_vat, 0);
      const weekCount = weekSales.length;
      const weekAverage = weekCount > 0 ? weekTotal / weekCount : 0;
      const weekCommission = weekSales.reduce((sum, s) => sum + s.commission, 0);
      
      const monthTotal = monthSales.reduce((sum, s) => sum + s.net_without_vat, 0);
      const monthCount = monthSales.length;
      const monthAverage = monthCount > 0 ? monthTotal / monthCount : 0;
      const monthCommission = monthSales.reduce((sum, s) => sum + s.commission, 0);
      
      document.getElementById('kpiDayTotal').textContent = formatCLP(dayTotal);
      document.getElementById('kpiDayCount').textContent = dayCount;
      document.getElementById('kpiDayAverage').textContent = formatCLP(dayAverage);
      document.getElementById('kpiDayCommission').textContent = formatCLP(dayCommission);
      
      document.getElementById('kpiWeekTotal').textContent = formatCLP(weekTotal);
      document.getElementById('kpiWeekCount').textContent = weekCount;
      document.getElementById('kpiWeekAverage').textContent = formatCLP(weekAverage);
      document.getElementById('kpiWeekCommission').textContent = formatCLP(weekCommission);
      
      document.getElementById('kpiMonthTotal').textContent = formatCLP(monthTotal);
      document.getElementById('kpiMonthCount').textContent = monthCount;
      document.getElementById('kpiMonthAverage').textContent = formatCLP(monthAverage);
      document.getElementById('kpiMonthCommission').textContent = formatCLP(monthCommission);
      
      renderHourlyChart(daySales);
    }

    // ==================== FUNCIONES AUXILIARES PARA KPIs ====================
    function getStartOfWeek() {
      const now = new Date();
      const day = now.getDay();
      const diff = day === 0 ? 6 : day - 1;
      const startOfWeek = new Date(now);
      startOfWeek.setDate(now.getDate() - diff);
      startOfWeek.setHours(0, 0, 0, 0);
      return startOfWeek.toISOString().split('T')[0];
    }

    function isDateInWeek(dateString, startOfWeek) {
      const date = new Date(dateString);
      const start = new Date(startOfWeek);
      const end = new Date(start);
      end.setDate(start.getDate() + 6);
      
      return date >= start && date <= end;
    }

    function renderHourlyChart(daySales) {
      const hourlyData = {};
      daySales.forEach(sale => {
        const hour = new Date(sale.timestamp).getHours();
        const hourLabel = `${hour}:00`;
        hourlyData[hourLabel] = (hourlyData[hourLabel] || 0) + sale.net_without_vat;
      });
      
      const hours = Object.keys(hourlyData).sort((a, b) => {
        const hourA = parseInt(a.split(':')[0]);
        const hourB = parseInt(b.split(':')[0]);
        return hourA - hourB;
      });
      
      const values = hours.map(hour => hourlyData[hour]);
      
      if (hours.length === 0) {
        hours.push('Sin datos');
        values.push(0);
      }
      
      const ctx = document.getElementById('hourlyChart');
      if (hourlyChartInstance) {
        hourlyChartInstance.destroy();
      }
      
      hourlyChartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: hours,
          datasets: [{
            label: 'Ventas por Hora (sin IVA)',
            data: values,
            backgroundColor: '#f7c600',
            borderColor: '#d1a400',
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          plugins: {
            legend: {
              display: false
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  return formatCLP(context.parsed.y);
                }
              }
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                callback: function(value) {
                  return formatCLP(value);
                },
                color: '#999999'
              },
              grid: {
                color: '#2a2a2a'
              }
            },
            x: {
              ticks: {
                color: '#999999'
              },
              grid: {
                color: '#2a2a2a'
              }
            }
          }
        }
      });
    }

    // ==================== FUNCIONES EXISTENTES (SIN CAMBIOS) ====================
    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
      document.getElementById('installPrompt').classList.add('show');
    });

    function installApp() {
      if (deferredPrompt) {
        deferredPrompt.prompt();
        deferredPrompt.userChoice.then((choiceResult) => {
          if (choiceResult.outcome === 'accepted') {
            document.getElementById('installPrompt').classList.remove('show');
          }
          deferredPrompt = null;
        });
      }
    }

    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register(createServiceWorkerBlob()).then(() => {
        console.log('Service Worker registrado');
      });
    }

    function createServiceWorkerBlob() {
      const swCode = `
        const CACHE_NAME = 'comisiones-v1';
        self.addEventListener('install', (e) => {
          e.waitUntil(
            caches.open(CACHE_NAME).then((cache) => {
              return cache.addAll(['/']);
            })
          );
        });
        self.addEventListener('fetch', (e) => {
          e.respondWith(
            caches.match(e.request).then((response) => {
              return response || fetch(e.request);
            })
          );
        });
      `;
      const blob = new Blob([swCode], { type: 'application/javascript' });
      return URL.createObjectURL(blob);
    }

    const manifest = {
      name: "Sistema de Comisiones",
      short_name: "Comisiones",
      description: "Sistema de comisiones offline para vendedores",
      start_url: location.href,
      display: "standalone",
      background_color: "#0f0f10",
      theme_color: "#f7c600",
      orientation: "portrait",
      icons: [
        {
          src: "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'%3E%3Crect fill='%23f7c600' width='512' height='512'/%3E%3Ctext x='256' y='360' font-size='280' text-anchor='middle' fill='%23111111' font-weight='bold'%3Eüí∞%3C/text%3E%3C/svg%3E",
          sizes: "512x512",
          type: "image/svg+xml"
        }
      ]
    };

    const manifestBlob = new Blob([JSON.stringify(manifest)], { type: 'application/json' });
    const manifestURL = URL.createObjectURL(manifestBlob);
    document.getElementById('manifest-placeholder').setAttribute('href', manifestURL);

    function getStorage(key) {
      try {
        const data = localStorage.getItem(key);
        return data ? JSON.parse(data) : [];
      } catch (e) {
        console.error('Error reading storage:', e);
        return [];
      }
    }

    function setStorage(key, value) {
      try {
        localStorage.setItem(key, JSON.stringify(value));
        return true;
      } catch (e) {
        console.error('Error saving storage:', e);
        alert('Error al guardar datos. Verifica el espacio disponible.');
        return false;
      }
    }

    function formatCLP(amount) {
      const num = Math.round(parseFloat(amount) || 0);
      const sign = num < 0 ? '-' : '';
      const abs = Math.abs(num);
      return `${sign}$ ${abs.toLocaleString('es-CL')}`;
    }

    function formatDateForExcel(isoString) {
      if (!isoString) return '';
      const date = new Date(isoString);
      const day = String(date.getDate()).padStart(2, '0');
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const year = String(date.getFullYear()).slice(-2);
      return `${day}/${month}/${year}`;
    }

    function formatDateTimeForExcel(isoString) {
      if (!isoString) return '';
      const date = new Date(isoString);
      const day = String(date.getDate()).padStart(2, '0');
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const year = String(date.getFullYear()).slice(-2);
      const hours = String(date.getHours()).padStart(2, '0');
      const minutes = String(date.getMinutes()).padStart(2, '0');
      return `${day}/${month}/${year} ${hours}:${minutes}`;
    }

    function parseAmount(str) {
      if (!str) throw new Error('Introduce un n√∫mero v√°lido');
      const cleaned = str.replace(/[^0-9]/g, '');
      if (!cleaned) throw new Error('Introduce un n√∫mero v√°lido');
      return parseFloat(cleaned);
    }

    function getCurrentDate() {
      const now = new Date();
      return now.toISOString().split('T')[0];
    }

    function getCurrentMonth() {
      const now = new Date();
      return `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
    }

    function round2(x) {
      return Math.floor(x * 100 + 0.5) / 100;
    }

    function addSale() {
      const input = document.getElementById('amountInput');
      const amountText = input.value;
      
      try {
        const amt = parseAmount(amountText);
        const net = amt / 1.19;
        const commission = net * COMMISSION_RATE;
        
        const sale = {
          amount_with_vat: round2(amt),
          net_without_vat: round2(net),
          commission: round2(commission),
          timestamp: new Date().toISOString(),
          date_iso: getCurrentDate(),
          month_id: getCurrentMonth()
        };

        const permanentSales = getStorage('ventas_permanentes');
        permanentSales.push(sale);
        setStorage('ventas_permanentes', permanentSales);

        const salesMonth = getStorage('ventas_mes');
        salesMonth.push(sale);
        setStorage('ventas_mes', salesMonth);

        const salesDay = getStorage('ventas_dia');
        salesDay.push(sale);
        setStorage('ventas_dia', salesDay);

        if (input.value) {
          input.value = '';
          refreshUI();
          showToast('‚úì Venta agregada correctamente');
        }
      } catch (e) {
        alert(e.message);
      }
    }

    function deleteLastSale() {
      const salesDay = getStorage('ventas_dia');
      
      if (salesDay.length === 0) {
        alert('No hay ventas para eliminar');
        return;
      }
      
      const lastSale = salesDay[salesDay.length - 1];
      const lastAmount = formatCLP(lastSale.amount_with_vat);
      
      if (!confirm(`¬øEliminar la √∫ltima venta de ${lastAmount}?`)) {
        return;
      }
      
      const permanentSales = getStorage('ventas_permanentes');
      const permIndex = permanentSales.findIndex(s => 
        s.timestamp === lastSale.timestamp && 
        s.amount_with_vat === lastSale.amount_with_vat
      );
      if (permIndex !== -1) {
        permanentSales.splice(permIndex, 1);
        setStorage('ventas_permanentes', permanentSales);
      }
      
      salesDay.pop();
      setStorage('ventas_dia', salesDay);
      
      const salesMonth = getStorage('ventas_mes');
      const monthIndex = salesMonth.findIndex(s => 
        s.timestamp === lastSale.timestamp && 
        s.amount_with_vat === lastSale.amount_with_vat
      );
      if (monthIndex !== -1) {
        salesMonth.splice(monthIndex, 1);
        setStorage('ventas_mes', salesMonth);
      }
      
      refreshUI();
      showToast('‚úì √öltima venta eliminada');
    }

    function showToast(message) {
      const toast = document.createElement('div');
      toast.textContent = message;
      toast.style.cssText = `
        position: fixed;
        bottom: 80px;
        left: 50%;
        transform: translateX(-50%);
        background: #10b981;
        color: white;
        padding: 12px 24px;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 600;
        z-index: 10000;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      `;
      document.body.appendChild(toast);
      setTimeout(() => toast.remove(), 2000);
    }

    function closeDay() {
      setStorage('ventas_dia', []);
      refreshUI();
      showToast('‚úì D√≠a cerrado. Ventas del d√≠a vaciadas.');
    }

    function closeMonth() {
      setStorage('ventas_dia', []);
      setStorage('ventas_mes', []);
      refreshUI();
      showToast('‚úì Mes cerrado. Ventas del d√≠a y del mes vaciadas.');
    }

    function resetAll() {
      if (!confirm('‚ö†Ô∏è ¬øEst√°s COMPLETAMENTE SEGURO? Se borrar√°n TODOS los datos de forma PERMANENTE.')) {
        return;
      }
      setStorage('ventas_dia', []);
      setStorage('ventas_mes', []);
      setStorage('ventas_permanentes', []);
      refreshUI();
      showToast('Sistema reseteado');
    }

    function exportToExcel() {
      showModal('exportModal');
      updateExportOptions();
    }

    function updateExportOptions() {
      const exportType = document.getElementById('exportType').value;
      const dateSelector = document.getElementById('dateSelector');
      const dateSelect = document.getElementById('dateSelect');
      
      dateSelect.innerHTML = '';
      
      if (exportType === 'day') {
        dateSelector.style.display = 'block';
        const salesDay = getStorage('ventas_dia');
        const today = getCurrentDate();
        
        if (salesDay.length > 0) {
          const option = document.createElement('option');
          option.value = today;
          option.textContent = `${today} (D√≠a actual - ${salesDay.length} ventas)`;
          dateSelect.appendChild(option);
        } else {
          const option = document.createElement('option');
          option.textContent = 'No hay ventas hoy';
          dateSelect.appendChild(option);
        }
      } else if (exportType === 'month') {
        dateSelector.style.display = 'block';
        const salesMonth = getStorage('ventas_mes');
        const currentMonth = getCurrentMonth();
        const currentSales = salesMonth.filter(s => s.month_id === currentMonth);
        
        if (currentSales.length > 0) {
          const option = document.createElement('option');
          option.value = currentMonth;
          option.textContent = `${currentMonth} (Mes actual - ${currentSales.length} ventas)`;
          dateSelect.appendChild(option);
        } else {
          const option = document.createElement('option');
          option.textContent = 'No hay ventas en el mes actual';
          dateSelect.appendChild(option);
        }
      } else if (exportType === 'permanent') {
        dateSelector.style.display = 'block';
        const permanentSales = getStorage('ventas_permanentes');
        
        const uniqueMonths = [...new Set(permanentSales.map(s => s.month_id).filter(Boolean))].sort().reverse();
        
        const allOption = document.createElement('option');
        allOption.value = 'all';
        allOption.textContent = 'Todos los meses';
        dateSelect.appendChild(allOption);
        
        uniqueMonths.forEach(month => {
          const monthSales = permanentSales.filter(s => s.month_id === month);
          const option = document.createElement('option');
          option.value = month;
          option.textContent = `${month} (${monthSales.length} ventas)`;
          dateSelect.appendChild(option);
        });
        
        if (dateSelect.options.length === 1) {
          const option = document.createElement('option');
          option.textContent = 'No hay ventas en historial permanente';
          dateSelect.appendChild(option);
        }
      } else {
        dateSelector.style.display = 'none';
      }
    }

    function confirmExport() {
      const exportType = document.getElementById('exportType').value;
      const dateSelect = document.getElementById('dateSelect');
      const selectedDate = dateSelect.value;
      
      let data = [];
      let filename = '';
      
      if (exportType === 'day') {
        const salesDay = getStorage('ventas_dia');
        const today = getCurrentDate();
        
        if (selectedDate === today) {
          data = salesDay;
          filename = `ventas_dia_${selectedDate}.csv`;
        }
      } else if (exportType === 'month') {
        const currentMonth = getCurrentMonth();
        const salesMonth = getStorage('ventas_mes');
        
        if (selectedDate === currentMonth) {
          data = salesMonth.filter(s => s.month_id === currentMonth);
          filename = `ventas_mes_${selectedDate}.csv`;
        }
      } else if (exportType === 'permanent') {
        const permanentSales = getStorage('ventas_permanentes');
        
        if (selectedDate === 'all') {
          data = permanentSales;
          filename = 'historial_permanente_completo.csv';
        } else {
          data = permanentSales.filter(s => s.month_id === selectedDate);
          filename = `historial_permanente_${selectedDate}.csv`;
        }
      }
      
      if (data.length === 0) {
        alert('No hay datos para exportar en la selecci√≥n elegida');
        return;
      }
      
      let csv = 'Fecha/Hora,Monto con IVA,Neto sin IVA,Comisi√≥n,Fecha,Mes\n';
      data.forEach(s => {
        const timestamp = formatDateTimeForExcel(s.timestamp);
        const dateFormatted = formatDateForExcel(s.date_iso || s.timestamp);
        csv += `"${timestamp}",${s.amount_with_vat},${s.net_without_vat},${s.commission},"${dateFormatted}","${s.month_id}"\n`;
      });
      
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = filename;
      link.click();
      
      hideModal('exportModal');
      showToast(`‚úì Exportado: ${filename}`);
    }

    function showModifyModal() {
      showModal('modifyModal');
      document.getElementById('saleDate').value = getCurrentDate();
      document.getElementById('saleAmount').value = '';
      document.getElementById('searchQuery').value = '';
      updateModifyAction();
    }

    function updateModifyAction() {
      const action = document.getElementById('modifyAction').value;
      const addSection = document.getElementById('addSaleSection');
      const deleteSection = document.getElementById('deleteSaleSection');
      const searchSection = document.getElementById('searchSaleSection');
      
      if (action === 'add') {
        addSection.style.display = 'block';
        deleteSection.style.display = 'none';
        searchSection.style.display = 'none';
      } else if (action === 'delete') {
        addSection.style.display = 'none';
        deleteSection.style.display = 'block';
        searchSection.style.display = 'none';
        updateDeleteList();
      } else if (action === 'search') {
        addSection.style.display = 'none';
        deleteSection.style.display = 'none';
        searchSection.style.display = 'block';
        searchPermanentSales();
      }
    }

    function updateDeleteList() {
      const period = document.getElementById('deletePeriod').value;
      const container = document.getElementById('salesListToDelete');
      container.innerHTML = '';
      
      let sales = [];
      if (period === 'day') {
        sales = getStorage('ventas_dia');
      } else if (period === 'month') {
        const currentMonth = getCurrentMonth();
        const allSales = getStorage('ventas_mes');
        sales = allSales.filter(s => s.month_id === currentMonth);
      } else if (period === 'permanent') {
        sales = getStorage('ventas_permanentes');
      }
      
      if (sales.length === 0) {
        container.innerHTML = '<div style="padding: 12px; color: var(--muted); text-align: center;">No hay ventas para eliminar</div>';
        return;
      }
      
      sales.forEach((sale, index) => {
        const div = document.createElement('div');
        div.style.cssText = `
          padding: 12px;
          margin: 4px 0;
          background: var(--card);
          border: 1px solid var(--border);
          border-radius: 8px;
          cursor: pointer;
          transition: all 0.2s;
        `;
        
        const time = formatDateTimeForExcel(sale.timestamp);
        
        div.innerHTML = `
          <div style="display: flex; justify-content: space-between; align-items: center;">
            <div style="flex: 1;">
              <div style="font-weight: 600; color: var(--accent);">${formatCLP(sale.amount_with_vat)}</div>
              <div style="font-size: 12px; color: var(--muted);">${time} | Com: ${formatCLP(sale.commission)}</div>
            </div>
            <button onclick="deleteSaleFromPeriod('${period}', ${index})" style="background: #dc2626; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: 600;">Eliminar</button>
          </div>
        `;
        
        container.appendChild(div);
      });
    }

    function searchPermanentSales() {
      const query = document.getElementById('searchQuery').value.toLowerCase();
      const container = document.getElementById('searchResults');
      container.innerHTML = '';
      
      const permanentSales = getStorage('ventas_permanentes');
      
      if (permanentSales.length === 0) {
        container.innerHTML = '<div style="padding: 12px; color: var(--muted); text-align: center;">No hay ventas en el historial permanente</div>';
        return;
      }
      
      let filteredSales = permanentSales;
      
      if (query) {
        filteredSales = permanentSales.filter(sale => {
          const monthId = sale.month_id || '';
          const amount = sale.amount_with_vat.toString();
          const date = sale.date_iso || '';
          return monthId.toLowerCase().includes(query) || 
                 amount.includes(query) ||
                 date.toLowerCase().includes(query);
        });
      }
      
      if (filteredSales.length === 0) {
        container.innerHTML = '<div style="padding: 12px; color: var(--muted); text-align: center;">No se encontraron ventas</div>';
        return;
      }
      
      filteredSales.slice(0, 50).forEach((sale, index) => {
        const div = document.createElement('div');
        div.style.cssText = `
          padding: 12px;
          margin: 4px 0;
          background: var(--card);
          border: 1px solid var(--border);
          border-radius: 8px;
        `;
        
        const time = formatDateTimeForExcel(sale.timestamp);
        
        div.innerHTML = `
          <div style="flex: 1;">
            <div style="font-weight: 600; color: var(--accent);">${formatCLP(sale.amount_with_vat)}</div>
            <div style="font-size: 12px; color: var(--muted);">${time} | Com: ${formatCLP(sale.commission)}</div>
            <div style="font-size: 11px; color: #666; margin-top: 4px;">Fecha: ${sale.date_iso} | Mes: ${sale.month_id}</div>
          </div>
        `;
        
        container.appendChild(div);
      });
    }

    function deleteSaleFromPeriod(period, index) {
      if (!confirm('¬øEst√°s seguro de eliminar esta venta? Esta acci√≥n no se puede deshacer.')) {
        return;
      }
      
      let saleToDelete;
      
      if (period === 'day') {
        const salesDay = getStorage('ventas_dia');
        saleToDelete = salesDay[index];
        
        const permanentSales = getStorage('ventas_permanentes');
        const permIndex = permanentSales.findIndex(s => 
          s.timestamp === saleToDelete.timestamp && 
          s.amount_with_vat === saleToDelete.amount_with_vat
        );
        if (permIndex !== -1) {
          permanentSales.splice(permIndex, 1);
          setStorage('ventas_permanentes', permanentSales);
        }
        
        salesDay.splice(index, 1);
        setStorage('ventas_dia', salesDay);
        
        const salesMonth = getStorage('ventas_mes');
        const monthIndex = salesMonth.findIndex(s => 
          s.timestamp === saleToDelete.timestamp && 
          s.amount_with_vat === saleToDelete.amount_with_vat
        );
        if (monthIndex !== -1) {
          salesMonth.splice(monthIndex, 1);
          setStorage('ventas_mes', salesMonth);
        }
        
      } else if (period === 'month') {
        const currentMonth = getCurrentMonth();
        const salesMonth = getStorage('ventas_mes');
        const monthSales = salesMonth.filter(s => s.month_id === currentMonth);
        saleToDelete = monthSales[index];
        
        const permanentSales = getStorage('ventas_permanentes');
        const permIndex = permanentSales.findIndex(s => 
          s.timestamp === saleToDelete.timestamp && 
          s.amount_with_vat === saleToDelete.amount_with_vat
        );
        if (permIndex !== -1) {
          permanentSales.splice(permIndex, 1);
          setStorage('ventas_permanentes', permanentSales);
        }
        
        const fullIndex = salesMonth.findIndex(s => 
          s.timestamp === saleToDelete.timestamp && 
          s.amount_with_vat === saleToDelete.amount_with_vat
        );
        if (fullIndex !== -1) {
          salesMonth.splice(fullIndex, 1);
          setStorage('ventas_mes', salesMonth);
        }
        
        const today = getCurrentDate();
        if (saleToDelete.date_iso === today) {
          const salesDay = getStorage('ventas_dia');
          const dayIndex = salesDay.findIndex(s => 
            s.timestamp === saleToDelete.timestamp && 
            s.amount_with_vat === saleToDelete.amount_with_vat
          );
          if (dayIndex !== -1) {
            salesDay.splice(dayIndex, 1);
            setStorage('ventas_dia', salesDay);
          }
        }
        
      } else if (period === 'permanent') {
        const permanentSales = getStorage('ventas_permanentes');
        saleToDelete = permanentSales[index];
        
        permanentSales.splice(index, 1);
        setStorage('ventas_permanentes', permanentSales);
        
        const currentMonth = getCurrentMonth();
        if (saleToDelete.month_id === currentMonth) {
          const salesMonth = getStorage('ventas_mes');
          const monthIndex = salesMonth.findIndex(s => 
            s.timestamp === saleToDelete.timestamp && 
            s.amount_with_vat === saleToDelete.amount_with_vat
          );
          if (monthIndex !== -1) {
            salesMonth.splice(monthIndex, 1);
            setStorage('ventas_mes', salesMonth);
          }
        }
        
        const today = getCurrentDate();
        if (saleToDelete.date_iso === today) {
          const salesDay = getStorage('ventas_dia');
          const dayIndex = salesDay.findIndex(s => 
            s.timestamp === saleToDelete.timestamp && 
            s.amount_with_vat === saleToDelete.amount_with_vat
          );
          if (dayIndex !== -1) {
            salesDay.splice(dayIndex, 1);
            setStorage('ventas_dia', salesDay);
          }
        }
      }
      
      refreshUI();
      updateDeleteList();
      showToast('‚úì Venta eliminada');
    }

    function confirmModify() {
      const action = document.getElementById('modifyAction').value;
      
      if (action === 'add') {
        const dateInput = document.getElementById('saleDate').value;
        const amountInput = document.getElementById('saleAmount').value;
        
        if (!dateInput) {
          alert('Por favor selecciona una fecha');
          return;
        }
        
        if (!amountInput) {
          alert('Por favor ingresa un monto');
          return;
        }
        
        try {
          const amt = parseAmount(amountInput);
          const net = amt / 1.19;
          const commission = net * COMMISSION_RATE;
          
          const now = new Date();
          const selectedDateTime = new Date(dateInput + 'T' + 
            String(now.getHours()).padStart(2, '0') + ':' + 
            String(now.getMinutes()).padStart(2, '0') + ':' + 
            String(now.getSeconds()).padStart(2, '0'));
          
          const sale = {
            amount_with_vat: round2(amt),
            net_without_vat: round2(net),
            commission: round2(commission),
            timestamp: selectedDateTime.toISOString(),
            date_iso: dateInput,
            month_id: dateInput.substring(0, 7)
          };
          
          const permanentSales = getStorage('ventas_permanentes');
          permanentSales.push(sale);
          setStorage('ventas_permanentes', permanentSales);
          
          const currentMonth = getCurrentMonth();
          if (dateInput.substring(0, 7) === currentMonth) {
            const salesMonth = getStorage('ventas_mes');
            salesMonth.push(sale);
            setStorage('ventas_mes', salesMonth);
          }
          
          const today = getCurrentDate();
          if (dateInput === today) {
            const salesDay = getStorage('ventas_dia');
            salesDay.push(sale);
            setStorage('ventas_dia', salesDay);
          }
          
          hideModal('modifyModal');
          refreshUI();
          showToast(`‚úì Venta agregada con fecha ${formatDateForExcel(dateInput)}`);
        } catch (e) {
          alert(e.message);
        }
      }
    }

    function refreshUI() {
      const salesDay = getStorage('ventas_dia');
      const salesMonth = getStorage('ventas_mes');
      const currentMonth = getCurrentMonth();
      const salesCurrentMonth = salesMonth.filter(s => s.month_id === currentMonth);

      const dayWithVat = round2(salesDay.reduce((sum, s) => sum + s.amount_with_vat, 0));
      const dayWithoutVat = round2(salesDay.reduce((sum, s) => sum + s.net_without_vat, 0));
      const dayCommission = round2(salesDay.reduce((sum, s) => sum + s.commission, 0));

      const monthWithVat = round2(salesCurrentMonth.reduce((sum, s) => sum + s.amount_with_vat, 0));
      const monthWithoutVat = round2(salesCurrentMonth.reduce((sum, s) => sum + s.net_without_vat, 0));
      const monthCommission = round2(salesCurrentMonth.reduce((sum, s) => sum + s.commission, 0));

      document.getElementById('dayWithVat').textContent = formatCLP(dayWithVat);
      document.getElementById('dayWithoutVat').textContent = formatCLP(dayWithoutVat);
      document.getElementById('dayCommission').textContent = formatCLP(dayCommission);
      document.getElementById('monthWithVat').textContent = formatCLP(monthWithVat);
      document.getElementById('monthWithoutVat').textContent = formatCLP(monthWithoutVat);
      document.getElementById('monthCommission').textContent = formatCLP(monthCommission);

      renderSalesList('salesDay', salesDay.slice(-20).reverse());
      renderSalesList('salesMonth', salesCurrentMonth.slice(-20).reverse());
      
      const permanentSales = getStorage('ventas_permanentes');
      renderPermanentSales(permanentSales.slice(-20).reverse());

      renderCharts();
    }

    function renderSalesList(elementId, sales) {
      const container = document.getElementById(elementId);
      container.innerHTML = '';
      sales.forEach((s, i) => {
        const div = document.createElement('div');
        div.className = 'sale-item';
        const time = s.timestamp.substring(0, 16).replace('T', ' ');
        div.textContent = `${i + 1}. ${formatCLP(s.amount_with_vat)} | Neto: ${formatCLP(s.net_without_vat)} | Com: ${formatCLP(s.commission)} | ${time}`;
        container.appendChild(div);
      });
    }

    function renderPermanentSales(sales) {
      const container = document.getElementById('permanentSales');
      container.innerHTML = '';
      
      if (sales.length === 0) {
        const div = document.createElement('div');
        div.className = 'sale-item';
        div.textContent = 'No hay ventas en el historial permanente';
        container.appendChild(div);
        return;
      }
      
      sales.forEach((s, i) => {
        const div = document.createElement('div');
        div.className = 'sale-item';
        const time = s.timestamp.substring(0, 16).replace('T', ' ');
        div.textContent = `${i + 1}. ${formatCLP(s.amount_with_vat)} | Com: ${formatCLP(s.commission)} | ${s.date_iso} | ${time}`;
        container.appendChild(div);
      });
    }

    function showModal(id) {
      document.getElementById(id).classList.add('active');
    }

    function hideModal(id) {
      document.getElementById(id).classList.remove('active');
    }

    function showCloseDayModal() {
      showModal('closeDayModal');
    }

    function showCloseMonthModal() {
      showModal('closeMonthModal');
    }

    function showResetModal() {
      showModal('resetModal');
    }

    function showExportModal() {
      showModal('exportModal');
      updateExportOptions();
    }

    function confirmCloseDay() {
      closeDay();
      hideModal('closeDayModal');
    }

    function confirmCloseMonth() {
      closeMonth();
      hideModal('closeMonthModal');
    }

    function confirmReset() {
      resetAll();
      hideModal('resetModal');
    }

    function renderCharts() {
      renderDailyChart();
      renderMonthlyChart();
    }

    function renderDailyChart() {
      const currentMonth = getCurrentMonth();
      const salesMonth = getStorage('ventas_mes');
      const salesCurrentMonth = salesMonth.filter(s => s.month_id === currentMonth);
      
      const dataMap = {};
      
      salesCurrentMonth.forEach(s => {
        const day = parseInt(s.date_iso.split('-')[2]);
        dataMap[day] = (dataMap[day] || 0) + s.commission;
      });

      const days = Object.keys(dataMap).map(Number).sort((a, b) => a - b);
      const values = days.map(d => dataMap[d]);

      if (days.length === 0) {
        days.push(1);
        values.push(0);
      }

      const ctx = document.getElementById('dailyChart');
      if (dailyChartInstance) {
        dailyChartInstance.destroy();
      }

      dailyChartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: days,
          datasets: [{
            label: 'Comisi√≥n',
            data: values,
            backgroundColor: '#f7c600',
            borderColor: '#d1a400',
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          plugins: {
            legend: {
              display: false
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  return formatCLP(context.parsed.y);
                }
              }
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                callback: function(value) {
                  return formatCLP(value);
                },
                color: '#999999'
              },
              grid: {
                color: '#2a2a2a'
              }
            },
            x: {
              ticks: {
                color: '#999999'
              },
              grid: {
                color: '#2a2a2a'
              }
            }
          }
        }
      });
    }

    function renderMonthlyChart() {
      const salesMonth = getStorage('ventas_mes');
      const currentMonth = getCurrentMonth();
      const currentCommission = round2(salesMonth.filter(s => s.month_id === currentMonth).reduce((sum, s) => sum + s.commission, 0));

      const monthNames = ['ENE', 'FEB', 'MAR', 'ABR', 'MAY', 'JUN', 'JUL', 'AGO', 'SEP', 'OCT', 'NOV', 'DIC'];
      const currentMonthNum = parseInt(currentMonth.split('-')[1]);
      const labels = [monthNames[currentMonthNum - 1]];
      const values = [currentCommission];

      const ctx = document.getElementById('monthlyChart');
      if (monthlyChartInstance) {
        monthlyChartInstance.destroy();
      }

      monthlyChartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [{
            label: 'Comisi√≥n',
            data: values,
            backgroundColor: '#111111',
            borderColor: '#444444',
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          plugins: {
            legend: {
              display: false
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  return formatCLP(context.parsed.y);
                }
              }
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                callback: function(value) {
                  return formatCLP(value);
                },
                color: '#999999'
              },
              grid: {
                color: '#2a2a2a'
              }
            },
            x: {
              ticks: {
                color: '#999999'
              },
              grid: {
                color: '#2a2a2a'
              }
            }
          }
        }
      });
    }

    // ==================== EVENT LISTENERS ====================
    document.addEventListener('DOMContentLoaded', () => {
      const saleDateInput = document.getElementById('saleDate');
      if (saleDateInput) {
        saleDateInput.value = getCurrentDate();
      }
      
      const searchQueryInput = document.getElementById('searchQuery');
      if (searchQueryInput) {
        searchQueryInput.addEventListener('input', searchPermanentSales);
      }
      
      const exportTypeSelect = document.getElementById('exportType');
      if (exportTypeSelect) {
        exportTypeSelect.addEventListener('change', updateExportOptions);
      }
      
      const saleAmountInput = document.getElementById('saleAmount');
      if (saleAmountInput) {
        saleAmountInput.addEventListener('input', (e) => {
          let value = e.target.value.replace(/[^0-9]/g, '');
          if (value) {
            const cursorPos = e.target.selectionStart;
            const oldLength = e.target.value.length;
            const num = parseInt(value);
            const formatted = '$ ' + num.toLocaleString('es-CL');
            e.target.value = formatted;
            const newLength = formatted.length;
            const diff = newLength - oldLength;
            e.target.setSelectionRange(cursorPos + diff, cursorPos + diff);
          }
        });
      }
      
      refreshUI();
    });

    document.getElementById('amountInput').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') addSale();
    });

    document.getElementById('amountInput').addEventListener('input', (e) => {
      let value = e.target.value.replace(/[^0-9]/g, '');
      if (value) {
        const cursorPos = e.target.selectionStart;
        const oldLength = e.target.value.length;
        
        const num = parseInt(value);
        const formatted = '$ ' + num.toLocaleString('es-CL');
        e.target.value = formatted;
        
        const newLength = formatted.length;
        const diff = newLength - oldLength;
        e.target.setSelectionRange(cursorPos + diff, cursorPos + diff);
      }
    });
  </script>
</body>
</html>